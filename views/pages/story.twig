{{include('partials/header.twig')}}

<!-- BLOCK PAGE => ACUTAL PAGE AJAX -->
<div class="block-page"></div>

<!-- PROFILE & TIMELINE INFO -->
<div class="image-placeholder"></div>
<div class="overlay"></div>
<div id="panel" class="panel-controller">
  <div id="panel-button" class="switcher"><img src="{{app.request.basepath}}/src/images/right_arrow.svg" alt=""></div>
  <div class="core-controller">
    <div class="body-situation">
      <img src="{{app.request.basepath}}/src/images/story/body.svg" alt="">
    </div>
    <div class="identity">
      <div class="row">
        <div class="data-item">
          <h2>Nom du patient</h2>
          <h3>{{userDB.firstName}} {{userDB.lastName}}</h3>
        </div>
        <div class="data-item">
          <h2>Âge</h2>
          <h3>{{userDB.age}}</h3>
        </div>
      </div>
      <div class="row">
        <div class="data-item">
          <h2>Lieu d'habitation</h2>
          <h3>{{userDB.location}}</h3>
        </div>
        <div class="data-item left">
          <h2>Sexe</h2>
          <h3>{{userDB.gender}}</h3>
        </div>
      </div>
      <div class="row">
        <div class="data-item">
          <h2>Votre progression ADN</h2>
          <img src="{{app.request.basepath}}/src/images/story/adn.svg" alt="">
        </div>
      </div>
    </div>
    <div class="separator"></div>
    <div class="upgrades-status">
      <div class="row">
        <div class="data-item success">
          <h2>Électrodes cervicales</h2>
          <h3>Implanté</h3>
        </div>
        <div class="data-item locked">
          <h2>Recherche d’amélioration</h2>
          <h3>En cours</h3>
        </div>
      </div>
      <div class="row">
        <div class="data-item failed">
          <h2>Prothèses jambaire</h2>
          <h3>Non implanté</h3>
        </div>
        <div class="data-item locked left">
          <h2>Recherche d’amélioration</h2>
          <h3>En cours</h3>
        </div>
      </div>
      <div class="row">
        <div class="data-item locked">
          <h2>Recherche d’amélioration</h2>
          <h3>En cours</h3>
        </div>
        <div class="data-item locked left-2">
          <h2>Recherche d’amélioration</h2>
          <h3>En cours</h3>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="audio-controller"></div>

<script type="text/javascript">

/*
*** FUNCTION AJAX
*/
function page_ajax(page, trigFunction) {
    var block_page = document.querySelector('.block-page');
    var request = new XMLHttpRequest();
    request.open('GET', '../views/pages/story/' + page + '.twig', true);
    request.onreadystatechange = function() {
        if(this.readyState == 4) {
            block_page.innerHTML = this.responseText;
            trigFunction;
        }
    }
    request.send();
    request = null;
}

/*
*** FUNCTION AJAX
*/
function page_ajax_player(page, video_name, switch_page) {
    var block_page = document.querySelector('.block-page');
    var request = new XMLHttpRequest();
    request.open('GET', '../views/pages/story/' + page + '.twig', true);
    request.onreadystatechange = function() {
        if(this.readyState == 4) {
            block_page.innerHTML = this.responseText;
            player(video_name, switch_page);
        }
    }
    request.send();
    request = null;
}

/*
*** FUNCTION AJAX DILEMMA 
*/
function page_ajax_dilemma(page, url_left, url_right) {
    var block_page = document.querySelector('.block-page');
    var request = new XMLHttpRequest();
    request.open('GET', '../views/pages/story/' + page + '.twig', true);
    request.onreadystatechange = function() {
        if(this.readyState == 4) {
            block_page.innerHTML = this.responseText;
            // TRIGGER FUNCTION SWIPE
            var left = new onSwipeValid("left",url_left);
            var right = new onSwipeValid("right",url_right);
        }
    }
    request.send();
    request = null;
}

/*
*** TRIGGER DILEMMA ON SPACE TOUCHE
*/
window.addEventListener("keydown",function(event) {
  if (event.which == 32) {
    page_ajax_dilemma('dilemma', 'browse', 'try');
  }
});

window.addEventListener("keydown",function(event) {
  if (event.which == 65) {
    var video_one = new page_ajax_player('video', 'video.mp4', 'info_01');
  }
});

window.addEventListener("keydown",function(event) {
  if (event.which == 90) {
    var video_two = new page_ajax_player('video', 'bg_video.mp4', 'info_01');
  }
});

/*
*** INIT 
*/

page_ajax('info_01');


/*
*** SWIPE
*/

function onSwipeValid(direction,page) {

  var that = this;
  that.swipe = {};
  that.swipe.container = document.querySelector('.'+direction+'-choice');

  that.swipe.cursor_signature = document.getElementById('cursor-signature-'+direction);
  that.selected = null, // Object of the element to be moved
  that.x_pos = 0, that.y_pos = 0, // Stores x & y coordinates of the mouse pointer
  that.x_elem = 0, that.y_elem = 0; // Stores top, left values (edge) of the element
  // Will be called when user starts dragging an element

  that._drag_init = function(elem) {
    // Store the object of the element which needs to be moved
    that.selected = elem;
    that.x_elem = that.x_pos - that.selected.offsetLeft;
  }

  // Will be called when user dragging an element
  that.swipe.validation = document.querySelector('#validation-'+direction);
  that.validation_size = parseInt(window.getComputedStyle(that.swipe.validation).getPropertyValue("width").substring(2, -3));
  that.validation_size /= 6.5;
  that.limit = that.swipe.validation.offsetLeft ;

  that._move_elem = function(e) {
    that.x_pos = document.all ? window.event.clientX : e.pageX;
    if (that.selected !== null) {
      var ratio = that.x_pos - that.x_elem;
      if (ratio < 0) {
        ratio = 0;
      } else if (ratio > that.limit) {
        ratio = that.limit + that.validation_size;
        that.swipe.cursor_signature.style.backgroundColor = "green";

        // AJAX REDIRECTION AFTER SWIPE
        page_ajax(page);

      } else if(ratio < 259){
        that.swipe.cursor_signature.style.backgroundColor = "background-color: rgba(79, 136, 255, 1) - #090f1b;";
      }
      that.selected.style.left = ratio + 'px';
    }
  }

  // Destroy the object when we are done
  that._destroy = function() {
    that.selected = null;
  }

  // Bind the functions...
  that.cursor = document.getElementById('cursor-signature-'+direction);
  that.cursor.onmousedown = function () {
    that._drag_init(that.cursor);
    return false;
  };

  this.swipe.container.onmousemove = this._move_elem;
  this.swipe.container.onmouseup = this._destroy;
}
</script>

{{include('partials/footer.twig')}}
